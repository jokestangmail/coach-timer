<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Coach Timer</title>
  <meta name="theme-color" content="#111827" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <style>
:root {
  --yellow: #fef08a;
  --yellow-200: #fde68a;
  --yellow-50: #fffbeb;
  --black: #111827;
  --blue: #1d4ed8;
  --emerald: #059669;
  --amber: #d97706;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --white: #ffffff;
}
* { box-sizing: border-box; }
html, body { margin: 0; padding: 0; font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--yellow-50); color: var(--black); }
.container { max-width: 1100px; margin: 0 auto; padding: 12px; }
header { position: sticky; top: 0; z-index: 20; backdrop-filter: blur(6px); background: rgba(255, 251, 235, 0.95); border-bottom: 1px solid var(--yellow-200); }
.row { display: grid; grid-template-columns: 1fr; gap: 12px; }
@media (min-width: 640px) { .row { grid-template-columns: 1fr 1fr; } }
@media (min-width: 1024px) { .row { grid-template-columns: 1fr 1fr 1fr; } }
.card { background: var(--white); border: 1px solid var(--yellow-200); border-radius: 16px; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); display: flex; flex-direction: column; gap: 8px; }
.titlebar { display: flex; align-items: center; gap: 8px; }
.titlebar input[type='text'] { flex: 1; border: 1px solid var(--yellow-200); border-radius: 8px; padding: 6px 8px; font-weight: 600; }
.btn { border: 1px solid var(--gray-300); background: var(--white); padding: 8px 10px; border-radius: 12px; font-weight: 600; cursor: pointer; }
.btn:hover { filter: brightness(0.98); }
.btn-primary { background: var(--black); color: var(--yellow); border: 1px solid #000; }
.btn-green { background: var(--emerald); color: #fff; border-color: var(--emerald); }
.btn-amber { background: var(--amber); color: #fff; border-color: var(--amber); }
.btn-blue { background: var(--blue); color: #fff; border-color: var(--blue); }
.btn-gray { background: var(--gray-200); color: #111; border-color: var(--gray-300); }
.muted { color: var(--gray-600); font-size: 12px; }
.pill { padding: 3px 8px; border: 1px solid var(--yellow-200); border-radius: 999px; background: #fff; }
.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
.timer { font-size: 32px; font-weight: 700; text-align: center; letter-spacing: -0.5px; }
.grid-btns { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
.laps { max-height: 120px; overflow: auto; border-top: 1px solid var(--yellow-200); padding-top: 6px; }
.toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
.input { border: 1px solid var(--yellow-200); border-radius: 8px; padding: 6px 8px; }
.brand { width: 36px; height: 36px; border-radius: 10px; background: #000; color: var(--yellow); display: grid; place-items: center; font-weight: 800; }
.footer { text-align: center; color: var(--gray-600); font-size: 12px; padding: 10px 0 30px; }
</style>
</head>
<body>
  <header>
    <div class="container" style="display:flex; gap:12px; align-items:center; justify-content:space-between; padding:10px 12px;">
      <div style="display:flex; align-items:center; gap:10px;">
        <div class="brand">ST</div>
        <input id="sessionName" class="input" style="font-weight:700; font-size:18px;" value="Start-of-Practice Sprints" />
      </div>
      <div class="toolbar">
        <button class="btn" onclick="preset(10)">10m</button>
        <button class="btn" onclick="preset(20)">20m</button>
        <button class="btn" onclick="preset(30)">30m</button>
        <button class="btn" onclick="preset(36.576)">40yd</button>
        <button class="btn-primary" onclick="exportCsv()">Export CSV</button>
        <button class="btn" onclick="addAthlete()">+ Add</button>
      </div>
    </div>
  </header>

  <main class="container">
    <p class="muted">Tip: Tap a name to edit. Set a distance (meters) to auto-calc pace. Each athlete's Start/Stop/Lap/Reset is independent.</p>
    <div id="cards" class="row"></div>
  </main>

  <div class="footer">Add this to your Home Screen for an app-like experience. Data is saved on your device.</div>

  <script>
  const STORAGE_KEY = "coach-timer-pwa-v1";

  function msToClock(ms) { if (!Number.isFinite(ms) || ms < 0) return "00:00.000";
    const m = Math.floor(ms/60000);
    const s = Math.floor((ms%60000)/1000);
    const x = Math.floor(ms%1000);
    return String(m).padStart(2,'0') + ":" + String(s).padStart(2,'0') + "." + String(x).padStart(3,'0'); }

  function paceText(ms, meters) { if (!meters || meters<=0 || !ms) return "–";
    const mps = meters / (ms/1000);
    const mph = mps * 2.23693629;
    return mps.toFixed(2) + " m/s • " + mph.toFixed(2) + " mph"; }

  function loadState() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || null; } catch(e){ return null; } }
  function saveState() { localStorage.setItem(STORAGE_KEY, JSON.stringify({ sessionName: sessionName.value, athletes })); }

  const defaultAthletes = Array.from({length:17}, (_,i)=> ({ id:i+1, name:"Boy "+(i+1), distance:20, timeMs:0, running:false, startedAt:0, laps:[] }));
  let state = loadState();
  let athletes = state?.athletes || defaultAthletes;
  const sessionName = document.getElementById('sessionName');
  sessionName.value = state?.sessionName || sessionName.value;
  sessionName.addEventListener('input', saveState);

  const cards = document.getElementById('cards');

  function render() { 
    cards.innerHTML = "";
    athletes.forEach(a => { 
      const card = document.createElement('div'); card.className = 'card';

      const bar = document.createElement('div'); bar.className = 'titlebar';
      const nameInput = document.createElement('input'); nameInput.type='text'; nameInput.value = a.name; 
      nameInput.addEventListener('input', (e)=> { a.name = e.target.value; saveState(); });
      const rm = document.createElement('button'); rm.className='btn'; rm.style.color='#b91c1c'; rm.textContent='Remove';
      rm.addEventListener('click', ()=> removeAthlete(a.id));
      bar.appendChild(nameInput); bar.appendChild(rm);
      card.appendChild(bar);

      const distRow = document.createElement('div'); distRow.style.display='flex'; distRow.style.alignItems='center'; distRow.style.gap='8px';
      const lbl = document.createElement('span'); lbl.textContent='Distance (m)'; lbl.className='muted';
      const dist = document.createElement('input'); dist.type='number'; dist.value=a.distance; dist.className='input'; dist.style.width='110px';
      dist.step='0.001'; 
      dist.addEventListener('input', (e)=> { a.distance = Number(e.target.value) || 0; saveState(); });
      const lapsCount = document.createElement('span'); lapsCount.textContent = 'Lap count: '+a.laps.length; lapsCount.className='muted'; lapsCount.style.marginLeft='auto';
      distRow.appendChild(lbl); distRow.appendChild(dist); distRow.appendChild(lapsCount);
      card.appendChild(distRow);

      const time = document.createElement('div'); time.className='timer mono'; time.textContent = msToClock(a.running ? (Date.now() - a.startedAt) : a.timeMs);
      card.appendChild(time);

      const pace = document.createElement('div'); pace.className='muted'; pace.style.textAlign='center'; pace.textContent = paceText(a.running ? (Date.now() - a.startedAt) : a.timeMs, a.distance);
      card.appendChild(pace);

      const btns = document.createElement('div'); btns.className='grid-btns';
      const startBtn = document.createElement('button'); startBtn.className = 'btn btn-green'; startBtn.textContent = 'Start';
      const stopBtn  = document.createElement('button'); stopBtn.className  = 'btn btn-amber'; stopBtn.textContent  = 'Stop';
      const lapBtn   = document.createElement('button'); lapBtn.className   = 'btn btn-blue';  lapBtn.textContent   = 'Lap';
      const resetBtn = document.createElement('button'); resetBtn.className = 'btn btn-gray';  resetBtn.textContent = 'Reset';

      startBtn.addEventListener('click', ()=> start(a.id));
      stopBtn.addEventListener('click',  ()=> stop(a.id));
      lapBtn.addEventListener('click',   ()=> lap(a.id));
      resetBtn.addEventListener('click', ()=> resetTimer(a.id));

      btns.appendChild(a.running ? stopBtn : startBtn);
      btns.appendChild(lapBtn); btns.appendChild(resetBtn);
      card.appendChild(btns);

      if (a.laps.length) {
        const laps = document.createElement('div'); laps.className='laps';
        const title = document.createElement('div'); title.className='muted'; title.textContent='Laps (latest last):'; laps.appendChild(title);
        a.laps.forEach((l,idx)=> {
          const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.fontFamily='ui-monospace, monospace';
          const no = document.createElement('span'); no.className='muted'; no.textContent = '#'+(idx+1);
          const val = document.createElement('span'); val.textContent = msToClock(l);
          row.appendChild(no); row.appendChild(val); laps.appendChild(row);
        });
        card.appendChild(laps);
      }

      cards.appendChild(card);
    });
  }

  function rerenderLive() { render(); } // full re-render every tick for simplicity

  function start(id) { athletes = athletes.map(a => a.id===id ? (a.running ? a : {...a, running:true, startedAt: Date.now() - a.timeMs}) : a); saveState(); render(); }
  function stop(id)  { athletes = athletes.map(a => a.id===id ? (!a.running ? a : {...a, running:false, timeMs: Date.now() - a.startedAt}) : a); saveState(); render(); }
  function lap(id)   { athletes = athletes.map(a => { if (a.id!==id) return a; const cur = a.running ? (Date.now() - a.startedAt) : a.timeMs; return {...a, laps:[...a.laps, cur]}; }); saveState(); render(); }
  function resetTimer(id) { athletes = athletes.map(a => a.id===id ? {...a, timeMs:0, running:false, startedAt:0, laps:[]} : a); saveState(); render(); }
  function removeAthlete(id) { athletes = athletes.filter(a => a.id!==id); saveState(); render(); }
  function addAthlete() { const nextId = athletes.length ? Math.max(...athletes.map(x=>x.id))+1 : 1; athletes = [...athletes, { id: nextId, name: "Boy "+nextId, distance: 20, timeMs:0, running:false, startedAt:0, laps:[] }]; saveState(); render(); }
  function preset(meters) { athletes = athletes.map(a => ({...a, distance: meters})); saveState(); render(); }

  function exportCsv() { 
    const rows = [];
    const header = ["Session","Athlete","Distance(m)","Best(ms)","Best(clock)","Last(ms)","Last(clock)","m/s","mph","All Laps (ms)"];
    rows.push(header);
    const bestVal = arr => arr.length ? Math.min(...arr) : 0;
    athletes.forEach(a => {
      const base = a.laps.length ? a.laps : (a.timeMs? [a.timeMs] : []);
      const best = bestVal(base);
      const last = a.laps.length ? a.laps[a.laps.length-1] : (a.timeMs || 0);
      const mps = (a.distance>0 && best>0) ? (a.distance / (best/1000)) : 0;
      const mph = mps * 2.23693629;
      rows.push([sessionName.value, a.name, a.distance||"", best||"", best?msToClock(best):"", last||"", last?msToClock(last):"", mps?mps.toFixed(2):"", mph?mph.toFixed(2):"", a.laps.join("|")]);
    });
    const csv = rows.map(r => r.map(v => { const s = String(v); return (s.includes(',')||s.includes('\n')||s.includes('"')) ? '"'+s.replaceAll('"','""')+'"' : s; }).join(",")).join("\n");
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href = url; a.download = (sessionName.value.replace(/[^a-z0-9]+/gi,'-').replace(/^-+|-+$/g,'')||'session') + "-" + new Date().toISOString().slice(0,19).replace(/[:T]/g,'-') + ".csv";
    a.click(); URL.revokeObjectURL(url);
  }

  // Initial render and live tick
  render();
  setInterval(rerenderLive, 150);

  // PWA registration
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('service-worker.js'); }
  </script>
</body>
</html>
