<!DOCTYPE html>
<html><head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Coach Timer v3.2a (simple)</title>
<link rel="manifest" href="manifest.json"><link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="theme-color" content="#111827">
<style>
body{font-family:-apple-system,system-ui,sans-serif;margin:0;background:#fffbeb;color:#111827}
header{background:#fff3;border-bottom:1px solid #ddd;padding:6px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px}
.brand{background:#111827;color:#facc15;padding:4px 8px;border-radius:6px;font-weight:700}
.btn{border:1px solid #ddd;background:#fff;padding:6px 9px;border-radius:6px;font-size:14px;cursor:pointer}
.btn-green{background:#059669;color:#fff}
.btn-red{background:#b91c1c;color:#fff}
.list{margin:10px}
.row{display:grid;grid-template-columns:24px 1fr 90px 200px 46px 46px;align-items:center;border-bottom:1px dashed #ddd;padding:6px 0;gap:6px}
.num{text-align:right;font-size:12px;color:#666}
.name-input{width:100%;padding:6px;border:1px solid #ddd;border-radius:6px}
.time{font-family:monospace;font-size:13px;text-align:center}
table{width:100%;border-collapse:collapse;margin:10px}
th,td{border-bottom:1px dashed #ddd;padding:6px 8px;font-size:13px;text-align:left}
.toolbar{display:flex;gap:6px;flex-wrap:wrap;margin:8px 10px}
</style>
</head>
<body>
<header>
 <div class="brand">ST</div>
 <div class="toolbar">
  <button class="btn" onclick="newSession()">New</button>
  <button class="btn" onclick="viewReport()">Report</button>
  <button class="btn" onclick="viewAllHistories()">All Histories</button>
  <button class="btn" onclick="closeSession()">Close</button>
 </div>
</header>
<main id="main"></main>

<script>
const STORAGE_KEY="ct-v3-2a"; const HISTORY_KEY="ct-hist-v3-2a";
function msToClock(ms){ if(!ms||ms<=0) return "00.000s"; return (ms/1000).toFixed(3)+"s"; }
const defaultNames=["Joan Alexander Cicua Lara","Cristobal Correa","Leonardo Ferrer","Guilherme Gomes","Esteban Gomez","Marcelo Gomez","Daniel Hernandez","Ignacio Herrera","Bernardo Kabbach","Dev Kumar","AMITAI LISANI","Cristobal Lander","Pedro Ramos","Juan Diego Rodriguez Alvizu","Tharun Sathish","Aaron Shakibi","Nicolas Suarez","Santiago"];
function makeDefault(){ return defaultNames.map((n,i)=>({id:i+1,name:n,timeMs:0,running:false,dnr:false})); }

let state = (function(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||null}catch(e){return null}})()
        || { players: makeDefault(), view: "timers", editing: null };
let history = (function(){try{return JSON.parse(localStorage.getItem(HISTORY_KEY))||{}}catch(e){return {}}})();

function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function saveHist(){ localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); }

function newSession(){ state.players.forEach(p=>{p.timeMs=0;p.running=false;p.dnr=false;}); state.view="timers"; saveState(); render(); }
function addPlayer(){ const id = state.players.length? Math.max(...state.players.map(p=>p.id))+1 : 1; state.players.push({id,name:"New Player",timeMs:0,running:false,dnr:false}); saveState(); render(); }
function remPlayer(id){ state.players = state.players.filter(p=>p.id!==id); saveState(); render(); }
function editName(id){ state.editing = id; saveState(); render(); setTimeout(()=>{ const el=document.getElementById('name-'+id); if(el) el.focus(); }, 50); }
function saveName(id,val){ const p=state.players.find(p=>p.id===id); if(p) p.name = val; state.editing=null; saveState(); render(); }
function toggleDnr(id){ const p=state.players.find(p=>p.id===id); if(p){ p.dnr=!p.dnr; p.running=false; saveState(); render(); } }
function start(id){ const p=state.players.find(p=>p.id===id); if(p){ p.running=true; p.startAt=Date.now()-(p.timeMs||0); p.dnr=false; saveState(); } }
function stop(id){ const p=state.players.find(p=>p.id===id); if(p&&p.running){ p.timeMs=Date.now()-p.startAt; p.running=false; saveState(); render(); } }
function resetOne(id){ const p=state.players.find(p=>p.id===id); if(p){ p.timeMs=0; p.running=false; saveState(); render(); } }
function fastestId(){ const arr=state.players.filter(p=>!p.dnr && p.timeMs>0 && !p.running); if(!arr.length) return null; return arr.reduce((a,b)=> a.timeMs<b.timeMs?a:b).id; }

function closeSession(){
  const date=new Date().toISOString();
  state.players.forEach(p=>{
    const rec = { date, timeMs: p.dnr? null : (p.timeMs||0), dnr: !!p.dnr };
    if(!history[p.id]) history[p.id] = [];
    history[p.id].push(rec);
  });
  saveHist();
  alert("Session saved to history.");
  newSession();
}

function viewReport(){ state.view="report"; saveState(); render(); }
function backToTimers(){ state.view="timers"; saveState(); render(); }
function viewHistory(id){ state.view={name:"hist", id}; saveState(); render(); }
function viewAllHistories(){ state.view="allhist"; saveState(); render(); }

function renderTimers(){
  const c = document.createElement('div'); c.className='list';

  state.players.forEach((p,i)=>{
    const r = document.createElement('div'); r.className='row';

    const num = document.createElement('div'); num.className='num'; num.textContent = String(i+1); r.appendChild(num);

    const nameCell = document.createElement('div');
    if(state.editing===p.id){
      const inp = document.createElement('input'); inp.className='name-input'; inp.id='name-'+p.id; inp.value=p.name;
      inp.addEventListener('blur', ()=>saveName(p.id, inp.value));
      inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter') saveName(p.id, inp.value); });
      nameCell.appendChild(inp);
    } else {
      const lab = document.createElement('div'); lab.textContent=p.name; nameCell.appendChild(lab);
    }
    r.appendChild(nameCell);

    const time = document.createElement('div'); time.className='time'; time.textContent = p.dnr? 'DNR' : msToClock(p.running ? (Date.now()-p.startAt) : p.timeMs); r.appendChild(time);

    const actions = document.createElement('div');
    const startBtn = document.createElement('button'); startBtn.className='btn btn-green'; startBtn.textContent='Start'; startBtn.onclick=()=>start(p.id);
    const stopBtn = document.createElement('button'); stopBtn.className='btn btn-red'; stopBtn.textContent='Stop'; stopBtn.onclick=()=>stop(p.id);
    const resetBtn = document.createElement('button'); resetBtn.className='btn'; resetBtn.textContent='Reset'; resetBtn.onclick=()=>resetOne(p.id);
    const dnrBtn = document.createElement('button'); dnrBtn.className='btn'; dnrBtn.textContent=p.dnr? 'Undo DNR':'DNR'; dnrBtn.onclick=()=>toggleDnr(p.id);
    actions.appendChild(p.running? stopBtn : startBtn);
    actions.appendChild(resetBtn);
    actions.appendChild(dnrBtn);
    r.appendChild(actions);

    const editCol = document.createElement('div');
    const editBtn = document.createElement('button'); editBtn.className='btn'; editBtn.textContent='✏️'; editBtn.title='Edit name'; editBtn.onclick=()=>editName(p.id);
    editCol.appendChild(editBtn); r.appendChild(editCol);

    const delCol = document.createElement('div');
    const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.textContent='✕'; delBtn.title='Delete'; delBtn.onclick=()=>remPlayer(p.id);
    delCol.appendChild(delBtn); r.appendChild(delCol);

    c.appendChild(r);
  });

  const tools = document.createElement('div'); tools.className='toolbar';
  const addBtn = document.createElement('button'); addBtn.className='btn'; addBtn.textContent='+ Add Player'; addBtn.onclick=addPlayer;
  const startAll = document.createElement('button'); startAll.className='btn'; startAll.textContent='Start All'; startAll.onclick=()=>state.players.forEach(p=>start(p.id));
  const stopAll = document.createElement('button'); stopAll.className='btn'; stopAll.textContent='Stop All'; stopAll.onclick=()=>state.players.forEach(p=>stop(p.id));
  const resetAll = document.createElement('button'); resetAll.className='btn'; resetAll.textContent='Reset All'; resetAll.onclick=()=>state.players.forEach(p=>resetOne(p.id));
  tools.appendChild(addBtn); tools.appendChild(startAll); tools.appendChild(stopAll); tools.appendChild(resetAll);
  c.appendChild(tools);

  return c;
}

function renderReport(){
  const c = document.createElement('div');
  const tools = document.createElement('div'); tools.className='toolbar';
  const back = document.createElement('button'); back.className='btn'; back.textContent='Back'; back.onclick=backToTimers;
  const clear = document.createElement('button'); clear.className='btn'; clear.textContent='Clear All History'; clear.onclick=()=>{ if(confirm('Clear ALL history?')){ history={}; saveHist(); alert('Cleared.'); } };
  tools.appendChild(back); tools.appendChild(clear); c.appendChild(tools);

  const t = document.createElement('table');
  const thead = document.createElement('thead'); const trh = document.createElement('tr');
  ['#','Name','Time','Tag','History'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
  thead.appendChild(trh); t.appendChild(thead);
  const tbody = document.createElement('tbody');

  const fastest = fastestId();
  state.players.forEach((p,i)=>{
    const tr = document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=String(i+1);
    const tms = p.running ? (Date.now()-p.startAt) : p.timeMs;
    const td2=document.createElement('td'); td2.textContent=p.name;
    const td3=document.createElement('td'); td3.textContent= p.dnr? 'DNR' : (tms? msToClock(tms) : '—');
    const td4=document.createElement('td'); td4.textContent= (fastest && p.id===fastest && !p.dnr && tms) ? 'FASTEST 🏅' : (p.dnr ? 'DNR' : '');
    const td5=document.createElement('td'); const hbtn=document.createElement('button'); hbtn.className='btn'; hbtn.textContent='History'; hbtn.onclick=()=>viewHistory(p.id); td5.appendChild(hbtn);
    [td1,td2,td3,td4,td5].forEach(td=>tr.appendChild(td));
    tbody.appendChild(tr);
  });
  t.appendChild(tbody); c.appendChild(t);
  return c;
}

function renderHistory(pid){
  const c = document.createElement('div');
  const tools = document.createElement('div'); tools.className='toolbar';
  const back = document.createElement('button'); back.className='btn'; back.textContent='Back to Report'; back.onclick=viewReport;
  tools.appendChild(back); c.appendChild(tools);

  const recs = history[pid] || [];
  const player = state.players.find(p=>p.id===pid) || {name:'Player'};
  const h3 = document.createElement('h3'); h3.textContent = player.name + ' — History'; h3.style.margin = '6px 10px'; c.appendChild(h3);

  const t = document.createElement('table');
  const thead = document.createElement('thead'); const trh = document.createElement('tr');
  ['Date','Time'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
  thead.appendChild(trh); t.appendChild(thead);
  const tbody = document.createElement('tbody');
  recs.forEach(r=>{
    const tr = document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent = (new Date(r.date)).toLocaleString();
    const td2=document.createElement('td'); td2.textContent = r.dnr ? 'DNR' : (r.timeMs ? msToClock(r.timeMs) : '—');
    tr.appendChild(td1); tr.appendChild(td2); tbody.appendChild(tr);
  });
  t.appendChild(tbody); c.appendChild(t);
  if(!recs.length){ const p=document.createElement('p'); p.textContent='No history yet.'; p.className='toolbar'; c.appendChild(p); }
  return c;
}

function renderAllHistories(){
  const c = document.createElement('div');
  const tools = document.createElement('div'); tools.className='toolbar';
  const back = document.createElement('button'); back.className='btn'; back.textContent='Back'; back.onclick=backToTimers;
  tools.appendChild(back); c.appendChild(tools);

  const t = document.createElement('table');
  const thead = document.createElement('thead'); const trh=document.createElement('tr');
  ['Name','Latest'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
  thead.appendChild(trh); t.appendChild(thead);
  const tbody = document.createElement('tbody');
  state.players.forEach(p=>{
    const recs = history[p.id] || [];
    const latest = recs.length ? recs[recs.length-1] : null;
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=p.name; td1.style.cursor='pointer'; td1.onclick=()=>viewHistory(p.id);
    const td2=document.createElement('td'); td2.textContent = latest ? (latest.dnr ? 'DNR' : (latest.timeMs? msToClock(latest.timeMs) : '—')) : '—';
    tr.appendChild(td1); tr.appendChild(td2); tbody.appendChild(tr);
  });
  t.appendChild(tbody); c.appendChild(t);
  return c;
}

function render(){
  const main = document.getElementById('main');
  main.innerHTML='';
  if(state.view==='timers'){ main.appendChild(renderTimers()); }
  else if(state.view==='report'){ main.appendChild(renderReport()); }
  else if(typeof state.view==='object' && state.view.name==='hist'){ main.appendChild(renderHistory(state.view.id)); }
  else if(state.view==='allhist'){ main.appendChild(renderAllHistories()); }
}

setInterval(()=>{ if(state.view==='timers') render(); }, 300);
render();

if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }
</script>
</body></html>