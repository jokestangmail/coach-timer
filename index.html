<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Coach Timer</title>
  <meta name="theme-color" content="#111827" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <style>
:root {
  --bg: #fffbeb;
  --line: #f4e5a1;
  --text: #111827;
  --muted: #6b7280;
  --accent: #111827;
  --green: #059669;
  --red: #b91c1c;
  --blue: #1d4ed8;
}
* { box-sizing: border-box; }
html, body { margin: 0; padding: 0; font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); }
header { position: sticky; top: 0; z-index: 20; backdrop-filter: blur(6px); background: rgba(255, 251, 235, 0.95); border-bottom: 1px solid var(--line); }
.container { max-width: 800px; margin: 0 auto; padding: 10px 12px; }
.brand { width: 32px; height: 32px; border-radius: 8px; background: var(--accent); color: #facc15; display: grid; place-items: center; font-weight: 800; }
.toolbar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.input { border: 1px solid var(--line); border-radius: 8px; padding: 6px 8px; background: #fff; }
.btn { border: 1px solid var(--line); background: #fff; padding: 8px 10px; border-radius: 10px; font-weight: 600; }
.btn:active { transform: scale(0.98); }
.btn-primary { background: var(--accent); color: #facc15; border-color: var(--accent); }
.btn-green { background: var(--green); color: #fff; border-color: var(--green); }
.btn-red { background: var(--red); color: #fff; border-color: var(--red); }
.btn-blue { background: var(--blue); color: #fff; border-color: var(--blue); }
.muted { color: var(--muted); font-size: 12px; }
.list { display: grid; grid-template-columns: 1fr; }
.row { display: grid; grid-template-columns: 28px 1fr 110px 92px 34px; align-items: center; gap: 8px; padding: 6px 4px; border-bottom: 1px dashed var(--line); }
.num { text-align: right; color: var(--muted); font-variant-numeric: tabular-nums; width: 28px; }
.name { width: 100%; border: none; background: transparent; padding: 6px 8px; border-radius: 8px; border: 1px solid transparent; }
.name:focus { outline: none; border-color: var(--line); background: #fff; }
.time { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; text-align: center; letter-spacing: -0.3px; }
.tiny { font-size: 12px; }
footer { text-align: center; padding: 18px 0 26px; color: var(--muted); }
@media (max-width: 390px) {
  .row { grid-template-columns: 24px 1fr 92px 84px 30px; gap: 6px; padding: 5px 2px; }
  .btn { padding: 6px 8px; }
}
</style>
</head>
<body>
  <header>
    <div class="container" style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
      <div style="display:flex; align-items:center; gap:10px;">
        <div class="brand">ST</div>
        <input id="sessionName" class="input" style="font-weight:700; font-size:18px; min-width: 160px;" value="Start-of-Practice Sprints" />
      </div>
      <div class="toolbar">
        <button class="btn" onclick="resetAll()">New session</button>
        <button class="btn-primary" onclick="shareResults()">Share</button>
        <button class="btn" onclick="downloadCsv()">CSV</button>
        <button class="btn" onclick="addPlayer()">+ Add</button>
      </div>
    </div>
  </header>

  <main class="container">
    <p class="muted tiny">Compact list for iPhone. Tap a name to edit. Each row has Start/Stop and Reset. Delete removes a player from this device.</p>
    <div id="list" class="list"></div>
  </main>

  <footer>Tip: Add to Home Screen in Safari for app-like experience. Data stays on your phone.</footer>

<script>
const STORAGE_KEY = "coach-timer-roster-v2";

function msToClock(ms){ if(!Number.isFinite(ms)||ms<0) return "00:00.000";
  const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000), x=Math.floor(ms%1000);
  return String(m).padStart(2,'0')+":"+String(s).padStart(2,'0')+"."+String(x).padStart(3,'0'); }

// Default roster (18 names)
const defaultNames = [
  "Joan Alexander Cicua Lara",
  "Cristobal Correa",
  "Leonardo Ferrer",
  "Guilherme Gomes",
  "Esteban Gomez",
  "Marcelo Gomez",
  "Daniel Hernandez",
  "Ignacio Herrera",
  "Bernardo Kabbach",
  "Dev Kumar",
  "AMITAI LISANI",
  "Cristobal Lander",
  "Pedro Ramos",
  "Juan Diego Rodriguez Alvizu",
  "Tharun Sathish",
  "Aaron Shakibi",
  "Nicolas Suarez",
  "Santiago"
];

function defaultRoster(){
  return defaultNames.map((n, i)=>({ id: i+1, name: n, timeMs: 0, running: false, startedAt: 0 }));
}

function load(){
  try{ const s = JSON.parse(localStorage.getItem(STORAGE_KEY)); if(s) return s; }catch(e){}
  return { sessionName: "Start-of-Practice Sprints", players: defaultRoster() };
}

let state = load();
const sessionNameEl = document.getElementById('sessionName');
sessionNameEl.value = state.sessionName || "Start-of-Practice Sprints";
sessionNameEl.addEventListener('input', ()=>{ state.sessionName = sessionNameEl.value; save(); });

const list = document.getElementById('list');

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
function addPlayer(){
  const nextId = state.players.length ? Math.max(...state.players.map(p=>p.id)) + 1 : 1;
  state.players.push({ id: nextId, name: "New Player", timeMs: 0, running: false, startedAt: 0 });
  save(); render();
}
function removePlayer(id){
  state.players = state.players.filter(p => p.id !== id);
  save(); render();
}
function start(id){
  state.players = state.players.map(p => p.id===id ? (p.running ? p : { ...p, running:true, startedAt: Date.now() - p.timeMs }) : p);
  save(); render();
}
function stop(id){
  state.players = state.players.map(p => p.id===id ? (!p.running ? p : { ...p, running:false, timeMs: Date.now() - p.startedAt }) : p);
  save(); render();
}
function reset(id){
  state.players = state.players.map(p => p.id===id ? { ...p, timeMs:0, running:false, startedAt:0 } : p);
  save(); render();
}
function resetAll(){
  state.players = state.players.map(p => ({ ...p, timeMs:0, running:false, startedAt:0 }));
  save(); render();
}

function render(){
  list.innerHTML = "";
  state.players.forEach((p, idx)=>{
    const row = document.createElement('div');
    row.className = 'row';

    const num = document.createElement('div'); num.className='num tiny'; num.textContent = String(idx+1);
    row.appendChild(num);

    const name = document.createElement('input'); name.className='name'; name.value = p.name;
    name.addEventListener('input', (e)=>{ p.name = e.target.value; save(); });
    row.appendChild(name);

    const time = document.createElement('div'); time.className='time tiny'; time.textContent = msToClock(p.running ? (Date.now() - p.startedAt) : p.timeMs);
    row.appendChild(time);

    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px';
    const startBtn = document.createElement('button'); startBtn.className='btn btn-green tiny'; startBtn.textContent='Start';
    const stopBtn  = document.createElement('button'); stopBtn.className='btn btn-red tiny';  stopBtn.textContent='Stop';
    startBtn.addEventListener('click', ()=>start(p.id)); stopBtn.addEventListener('click', ()=>stop(p.id));
    actions.appendChild(p.running ? stopBtn : startBtn);
    const resetBtn = document.createElement('button'); resetBtn.className='btn tiny'; resetBtn.textContent='Reset'; resetBtn.addEventListener('click', ()=>reset(p.id));
    actions.appendChild(resetBtn);
    row.appendChild(actions);

    const del = document.createElement('button'); del.className='btn tiny'; del.textContent='✕'; del.title='Delete';
    del.addEventListener('click', ()=>removePlayer(p.id));
    row.appendChild(del);

    list.appendChild(row);
  });
}

function tick(){ render(); }
setInterval(tick, 150);
render();

function csvData(){
  const rows = [];
  rows.push(["Session","Name","Time(ms)","Time(clock)"]);
  state.players.forEach(p=>{
    const t = p.running ? (Date.now() - p.startedAt) : p.timeMs;
    rows.push([state.sessionName, p.name, t || "", t ? msToClock(t) : ""]);
  });
  const csv = rows.map(r => r.map(v => {
    const s = String(v ?? ""); return (s.includes(",")||s.includes("\n")||s.includes('"')) ? '"' + s.replaceAll('"','""') + '"' : s;
  }).join(",")).join("\n");
  return csv;
}

function downloadCsv(){
  const csv = csvData();
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  a.href = url; a.download = (state.sessionName.replace(/[^a-z0-9]+/gi,'-') || 'session') + "-" + stamp + ".csv";
  a.click(); URL.revokeObjectURL(url);
}

async function shareResults(){
  const csv = csvData();
  const file = new File([csv], "results.csv", { type: "text/csv" });
  const text = state.players.map((p, i)=>{
    const t = p.running ? (Date.now() - p.startedAt) : p.timeMs;
    return String(i+1).padStart(2,'0') + ". " + p.name + " — " + (t? msToClock(t): "—");
  }).join("\n");
  if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
    try {
      await navigator.share({ title: state.sessionName, text, files: [file] });
    } catch(e) {
      console.log("Share canceled or failed", e);
    }
  } else if (navigator.share) {
    try {
      await navigator.share({ title: state.sessionName, text });
    } catch(e){ console.log(e); }
  } else {
    downloadCsv();
    alert("CSV downloaded. If sharing isn't available, send the file via Messages or Mail.");
  }
}

// Register service worker for offline
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('service-worker.js'); }
</script>
</body>
</html>
